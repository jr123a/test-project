String rawQuery = hsr.getQueryString();
nv.setBooleanValue(false);

if (StringUtils.isNotBlank(rawQuery)) {

    String[] pairs = rawQuery.split("&");
    for (String pair : pairs) {
        if (pair.isEmpty()) {
            continue;
        }

        int eqIdx = pair.indexOf('=');
        String name  = (eqIdx >= 0) ? pair.substring(0, eqIdx) : pair;
        String valuePart = (eqIdx >= 0 && eqIdx + 1 < pair.length())
                ? pair.substring(eqIdx + 1)
                : "";

        String decodedValue;
        try {
            decodedValue = URLDecoder.decode(valuePart, StandardCharsets.UTF_8.name());
        } catch (IllegalArgumentException ex) {
            CustomLogger.warn(this.getClass(),
                    "Malformed encoding in query parameter '" + name + "': " + valuePart);
            throw new SecurityException("Invalid query string encoding detected.");
        }

        // ---- BASIC SAFETY GUARD ----
        if (decodedValue.length() > 2048) {
            CustomLogger.warn(this.getClass(),
                    "Param '" + name + "' exceeded max length: " + decodedValue.length());
            throw new SecurityException("Invalid query parameter value detected.");
        }

        // ---- GLOBAL XSS CHECKS (for ALL params) ----
        if (DANGEROUS_CHARS.matcher(decodedValue).find()
                || SUSPICIOUS_KEYWORDS.matcher(decodedValue).find()) {
            CustomLogger.warn(this.getClass(),
                    "Potential XSS attack in param '" + name + "': " + decodedValue);
            throw new SecurityException("Potential XSS attack detected.");
        }

        // ---- STRICT ALLOW-LIST ONLY FOR do/cmd ----
        if ("do".equals(name) || "cmd".equals(name)) {
            if (!DO_CMD_VALUE_PATTERN.matcher(decodedValue).matches()) {
                CustomLogger.warn(this.getClass(),
                        "do/cmd param failed validation: " + decodedValue);
                throw new SecurityException("Invalid do/cmd value detected.");
            }
        }

        // ---- Everything else is allowed if not XSS ----
        // db=...  → Accepted
        // appURL=... → Accepted
        // tracking tokens → Accepted
        // OAuth tokens / USPS cookies → Accepted
    }

    // If all params passed:
    nv.setBooleanValue(true);
}
